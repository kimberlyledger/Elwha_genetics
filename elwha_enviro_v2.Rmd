---
title: "environmental_data_v2"
author: "Kimberly Ledger"
date: "6/3/2022"
output: github_document
---


load libraries
```{r}
library(tidyverse)
library(ggrepel)
library(terra)
```



## Steelhead 

read in steelhead metadata that has river km and gps locations of sampling sites 
```{r}
onmy_metadata <- read.csv("~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Steelhead_Formatted_kjl.csv")
head(onmy_metadata)
```

filter sites to include only post dam removal samples and create table of sampling sites 
```{r}
omy_sites <- onmy_metadata %>%
  filter(Time == "Post") %>%
  distinct(Lat, Long, rkm, Sampling_Site) %>%
  arrange(rkm)
omy_sites
```

export 
```{r}
#write.csv(sites, "onmy_sites.csv")
```


make dataframe of unique gps for steelhead sites

```{r}
latlong_omy <- omy_sites %>%
  distinct(Lat, Long, Sampling_Site) %>%
  drop_na()
```


plot all omy sampling locations 
```{r}
site_plot <- ggplot(omy_sites) + 
  geom_point(data = omy_sites, aes(x = Long, y = Lat, group = Sampling_Site)) +
  geom_text_repel(data = omy_sites, aes(x = Long, y = Lat, group = Sampling_Site, 
                                    label = Sampling_Site), hjust=1, vjust=0.5)
site_plot
```

plot omy sampling locations 
```{r}
site_plot <- ggplot(omy_sites) + 
  geom_text(data = omy_sites, aes(x = Long, y = Lat, label = Sampling_Site))

site_plot
```



## Chinook

read in chinook sites
```{r}
chinook_sites <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/Elwha_Chinook_DownstreamSites.csv")
```


plot
```{r}
site_plot <- ggplot(chinook_sites) + 
  geom_text(data = chinook_sites, aes(x = Long, y = Lat, label = Sampling_Site))

site_plot
```


read in chinook meta data
```{r}
chinook <- read.csv("~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Chinook_Formatted.csv")
```


filter sites to include only post dam removal samples and create table of sampling sites 
```{r}
chinook %>%
  filter(Time == "Post") %>%
  distinct(Sampling_Site)
```

join lat/long with chinook metadata
```{r}
chinook_join <- chinook %>%
  left_join(chinook_sites)
```

save for future use... 
```{r}
#write.csv(chinook_join, "~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Chinook_Formatted_wDownstreamLatLongrkm.csv")
```


make dataframe of unique gps coords for chinook sites
```{r}
latlong_chin <- chinook_sites %>%
  select(Lat, Long, Sampling_Site) 
```



### working with Lat Long ### 
create full sites of lat long sites 
```{r}
latlong_sites <- rbind(latlong_omy, latlong_chin) %>%
  distinct()
```


create SpatVect for sites 
```{r}
latlong_sites <- vect(latlong_sites, geom = c("Long", "Lat"))
crs(latlong_sites) <- "+proj=longlat" 
plot(latlong_sites)
```


## reference lat/long and rkm file 
read in the lat/long and rkm base file
```{r}
rkm_latlong <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/elwharkmlatlong.csv")
head(rkm_latlong)                       
```


## prep point-based environmental data 

1. read in pebble count, depth, width, etc... data 
```{r}
avg_elwha_msv <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/AVG_Elwha_MVS_AKF.csv")
#head(avg_elwha_msv)
```

filter to retain only environmental variables 
```{r}
avg_elwha_msv_filter <- avg_elwha_msv %>%
  filter(Year == 2015) %>%
  select(Rkm, Latitude, Longitude, Channel_Gradient, Discharge..BFQ., AVG_Percent_Spawn_Chin, AVG_Percent_Gravels)  %>% # will need to update AVG_Percent_Gravels to AVG_Percent_Steelhead 
  rename(RKM = Rkm, Lat = Latitude, Long = Longitude, Discharge = Discharge..BFQ.)
```


2. read in channel type data  -- DOES NOT INCLUDE GPS DATA so joining references coordinates
```{r}
channel <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/Channel_Type.csv")
#head(channel)
```

filter to retain only environmental variables 
```{r}
channel_filter <- channel %>%
    select(Rkm, Channel_type) %>%
  rename(RKM = Rkm) %>%
  left_join(rkm_latlong)
```


3. read in spawning habitat data - does not include GPS so joining references coordinates
```{r}
spawn <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/Steelhead_Spawnable_Habitat.csv")
head(spawn)
```

filter to retain only environmental variables 
```{r}
spawn_filter <- spawn %>%
  select(rkm, General_habitat, Sampling_Site, Channel_type, Area) %>%
  drop_na() %>%
  rename(RKM = rkm, Sampling_Site_spawn = Sampling_Site, Channel_type_spawn = Channel_type, Spawn_area_m2 = Area) %>%
  left_join(rkm_latlong)
```




4. read in ecosystem data 
```{r}
ecosystem_process <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/Ecosystem_Processes_Data.csv")
#head(ecosystem_process)
```

filter to retain only environmental variables 
```{r}
ecosystem_process_filter <- ecosystem_process %>%
  filter(SEASON == "Summer") %>%
  select(SITE, W_WIDTH, CANOPY, FINES, D50, LAT, LONG, rKM) %>%
  rename(RKM = rKM, Lat = LAT, Long = LONG)
```



5. read in invert data 
```{r}
invert <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/Invertebrate_Summary.csv")
head(invert)
```

## for GPS
filter to retain only environmental variables 
and for rkm with more than one invert sample, take mean
```{r}
invert_filter <- invert %>%
  select(BFW, LATITUDE, LONGITUDE) %>%
  drop_na(BFW) %>%
  rename(Lat = LATITUDE, Long = LONGITUDE)
```


6. read in pebble data 
```{r}
pebbles <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/Riffle_Pool_Pebbles.csv")
head(pebbles)
```

```{r}
pebbles_filtered <- pebbles %>%
  select(Latitude, Longitude, Rkm, Pebble_count_flow_CFS, Total_rifffle_area_m2) %>%
  rename(RKM = Rkm, Lat = Latitude, Long = Longitude)
```





Aimee's Elwha shapefile 
```{r, message=FALSE}
library(terra)
elwha <- terra::vect("~/Desktop/LG_Proj4/Elwha_environmentaldata/Elwha_streams/Elwha_streams.shp")
#elwha
```

```{r}
plot(elwha)
```

read in background raster - this is at a 30 sec resolution (1 km)
```{r}
myrast <- rast("~/Desktop/LG_Proj4/Elwha_environmentaldata/wc2.1_30s_prec/wc2.1_30s_prec_01_crop.tif")
plot(myrast)
```


```{r}
#elwha_raster <- rasterize(elwha, myrast)
#plot(elwha_raster)
```

turn environmental data into rasters... 


#### lets start by extracting by lat/long from avg_elwha_msv_filter


1. convert avg_elwha_msv_filter to SpatVect 
```{r}
avg_elwha_msv_vect <- vect(avg_elwha_msv_filter, geom = c("Long", "Lat"))
crs(avg_elwha_msv_vect) <- "+proj=longlat" 
plot(avg_elwha_msv_vect)
```

convert avg_elwha SpatVect to SpatRaster

```{r}
discharge_raster <- rasterize(avg_elwha_msv_vect, myrast, field = "Discharge", fun = mean)
plot(discharge_raster)
gradient_raster <- rasterize(avg_elwha_msv_vect, myrast, field = "Channel_Gradient", fun = mean)
plot(gradient_raster)
spawn_chin_raster <- rasterize(avg_elwha_msv_vect, myrast, field = "AVG_Percent_Spawn_Chin", fun = mean)
plot(spawn_chin_raster)
per_grav_raster <- rasterize(avg_elwha_msv_vect, myrast, field = "AVG_Percent_Gravels", fun = mean)
plot(spawn_chin_raster)
```

2. convert channel_filter to SpatVect 
```{r}
channel_vect <- vect(channel_filter, geom = c("Long", "Lat"))
crs(channel_vect) <- "+proj=longlat" 
plot(channel_vect)
```

convert channel_filter SpatVect to SpatRaster

```{r}
channel_raster <- rasterize(channel_vect, myrast, field = "Channel_type")
plot(channel_raster)
```




3. convert spawn_filter to SpatVect   - PROBLEM - same latlong and rkm listed for MS and tribs... how do we know which one to use for sites???? 
```{r}
spawn_vect <- vect(spawn_filter, geom = c("Long", "Lat"))
crs(spawn_vect) <- "+proj=longlat" 
plot(spawn_vect)
```

convert spawn_filter SpatVect to SpatRaster

```{r}
spawn_channel_raster <- rasterize(spawn_vect, myrast, field = "Channel_type_spawn")
plot(spawn_channel_raster)
spawn_area_raster <- rasterize(spawn_vect, myrast, field = "Spawn_area_m2", fun = mean)
plot(spawn_area_raster)
```



4. convert ecosystem_process_filter to SpatVect   
```{r}
ecosystem_vect <- vect(ecosystem_process_filter, geom = c("Long", "Lat"))
crs(ecosystem_vect) <- "+proj=longlat" 
plot(ecosystem_vect)
```

very few data location for the ecosystem processs data... moving on... 


5. convert invert_filter to SpatVect 
```{r}
invert_vect <- vect(invert_filter, geom = c("Long", "Lat"))
crs(invert_vect) <- "+proj=longlat" 
plot(invert_vect)
```

convert invert SpatVect to SpatRaster

```{r}
invert_raster <- rasterize(invert_vect, myrast, field = "BFW", fun = mean)
plot(invert_raster)
```

6. pebble_filter 

```{r}
pebbles_vect <- vect(pebbles_filtered, geom = c("Long", "Lat"))
crs(pebbles_vect) <- "+proj=longlat" 
plot(pebbles_vect)
```

convert pebble count SpatVect to SpatRaster

```{r}
pebble_count_raster <- rasterize(pebbles_vect, myrast, field = "Pebble_count_flow_CFS", fun = mean)
plot(pebble_count_raster)
```



### create a raster stack of all individual rasters 


```{r}
mystack <- c(spawn_channel_raster, spawn_area_raster, channel_raster, discharge_raster, gradient_raster, spawn_chin_raster, per_grav_raster, invert_raster, pebble_count_raster)
```


## try to extract data from site locations 

```{r}
test <- extract(mystack, latlong_sites)
```


## need to rename raster layers 



