---
title: "environmental_data_v2"
author: "Kimberly Ledger"
date: "6/3/2022"
output: github_document
---

### opted not to use this code and go with a manual extration of environemntal variable using ARCMAP 
### too many gaps/missing data with this code... 


load libraries
```{r}
library(tidyverse)
library(ggrepel)
library(terra)
```



## Steelhead 

read in steelhead metadata that has river km and gps locations of sampling sites 
```{r}
onmy_metadata <- read.csv("~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Steelhead_Formatted_kjl.csv")
head(onmy_metadata)
```

filter sites to include only post dam removal samples and create table of sampling sites 
```{r}
omy_sites <- onmy_metadata %>%
  filter(Time == "Post") %>%
  distinct(Lat, Long, rkm, Sampling_Site) %>%
  arrange(rkm)
omy_sites
```

rename the correct lekt_outlet site to be able to differentiate later on 

```{r}
omy_sites$Sampling_Site[10] <- "lekt_outlet_real"
omy_sites
```

make dataframe of unique gps for steelhead sites
```{r}
latlong_omy <- omy_sites %>%
  distinct(Lat, Long, Sampling_Site) %>%
  drop_na()
```


plot all omy sampling locations 
```{r}
site_plot <- ggplot(omy_sites) + 
  geom_point(data = omy_sites, aes(x = Long, y = Lat, group = Sampling_Site)) +
  geom_text_repel(data = omy_sites, aes(x = Long, y = Lat, group = Sampling_Site, 
                                    label = Sampling_Site), hjust=1, vjust=0.5)
site_plot
```

plot omy sampling locations 
```{r}
site_plot <- ggplot(omy_sites) + 
  geom_text(data = omy_sites, aes(x = Long, y = Lat, label = Sampling_Site))

site_plot
```



## Chinook

read in chinook sites
```{r}
chinook_sites <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/Elwha_Chinook_DownstreamSites.csv")
```


plot
```{r}
site_plot <- ggplot(chinook_sites) + 
  geom_text(data = chinook_sites, aes(x = Long, y = Lat, label = Sampling_Site))

site_plot
```


read in chinook meta data
```{r}
chinook <- read.csv("~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Chinook_Formatted.csv")
```


filter sites to include only post dam removal samples and create table of sampling sites 
```{r}
chinook %>%
  filter(Time == "Post") %>%
  distinct(Sampling_Site)
```

join lat/long with chinook metadata
```{r}
chinook_join <- chinook %>%
  left_join(chinook_sites)
```

save for future use... 
```{r}
#write.csv(chinook_join, "~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Chinook_Formatted_wDownstreamLatLongrkm.csv")
```


make dataframe of unique gps coords for chinook sites
```{r}
latlong_chin <- chinook_sites %>%
  select(Lat, Long, Sampling_Site) 
```


### working with Lat Long ### 
create full sites of lat long sites 
```{r}
latlong_sites <- rbind(latlong_omy, latlong_chin) %>%
  distinct()
```


create SpatVect for sites 
```{r}
latlong_sites <- vect(latlong_sites, geom = c("Long", "Lat"))
crs(latlong_sites) <- "+proj=longlat" 
plot(latlong_sites)

#writeVector(latlong_sites, "test_rasters_Kim/sites.shp", overwrite = TRUE)
writeVector(latlong_sites, "test_rasters_Kim/sites_update.shp", overwrite = TRUE) #this has a different site name for the correct lekt_outlet site
```


## an aside: convert pebbles csv into a shapefile

```{r}
pebbles <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/pebbles_2015.csv")

pebble_sites <- vect(pebbles, geom = c("Longitude", "Latitude"))
crs(pebble_sites) <- "+proj=longlat" 
plot(pebble_sites)

writeVector(pebble_sites, "test_rasters_Kim/pebble_sites.shp", overwrite = TRUE)
```





## plot sites on top of Elwha stream shapefile 
```{r, message=FALSE}
elwha <- terra::vect("~/Desktop/LG_Proj4/Elwha_environmentaldata/Elwha_streams/Elwha_streams.shp")
#elwha
```

```{r}
plot(elwha)
points(latlong_sites)
```



## reference lat/long and rkm file 
read in the lat/long and rkm base file
```{r}
rkm_latlong <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/elwharkmlatlong.csv")
head(rkm_latlong)                       
```



## prep point-based environmental data 

2. read in channel type data  -- DOES NOT INCLUDE GPS DATA so must join to references coordinates
```{r}
channel <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/glm_enviro/Channel_Type.csv")
#head(channel)
```

filter to retain only environmental variables (channel type) 
this data sheet also includes pool frequency(numerical) and particle size(categorical) - do we want to include these?
```{r}
channel_filter <- channel %>%
    select(Rkm, Channel_type) %>%
  rename(RKM = Rkm) %>%
  left_join(rkm_latlong)
```



## read in background raster - this is at a 30 sec resolution (1 km)

```{r}
myrast <- rast("~/Desktop/LG_Proj4/Elwha_environmentaldata/wc2.1_30s_prec/wc2.1_30s_prec_01_crop.tif")
myrast <- terra::project(myrast, crs(elwha))
plot(myrast)
```


## convert environmental point data into rasters... 

2. convert channel_filter to SpatVect 
```{r}
channel_vect <- vect(channel_filter, geom = c("Long", "Lat"))
crs(channel_vect) <- "+proj=longlat" 
plot(channel_vect)
```

convert channel_filter SpatVect to SpatRaster

```{r}
channel_raster <- terra::rasterize(channel_vect, myrast, field = "Channel_type")
plot(channel_raster)
```

```{r}
channel_dat <- extract(channel_raster, latlong_sites)
```


## convert environmental shapefiles into rasters 


## stream temperature - August  
```{r, message=FALSE}
st_august <- terra::vect("~/Desktop/LG_Proj4/Elwha_environmentaldata/StreamTempLayers_Kim/Elwha_ST_August2012-2017.shp")
plot(x=st_august, y='STemp')
```

convert stream temp SpatVector to SpatRaster
```{r}
st_august_raster <- rasterize(st_august, myrast, field = "STemp", fun = mean)
plot(st_august_raster)
```

## stream temperature - # of days >16C

```{r, message=FALSE}
st_16C <- terra::vect("~/Desktop/LG_Proj4/Elwha_environmentaldata/StreamTempLayers_Kim/Elwha_ST_Above16C.shp")
plot(x=st_16C, y='avg_h__')
```

convert stream temp SpatVector to SpatRaster
```{r}
st_16C_raster <- rasterize(st_16C, myrast, field = 'avg_h__', fun = mean)
plot(st_16C_raster)
```

## Terrainworks 

```{r}
tw <- terra::vect("~/Desktop/LG_Proj4/TerrainWorks_Dung_Elwha_Corrected/Terrainworks_Dung_Elwha.shp")
tw_proj <- terra::project(tw, crs(elwha))
```

makes a buffer around elwha shapefile to use a template
```{r}
elwha_buffer <- buffer(elwha, 500)

#writeVector(elwha_buffer, "test_rasters_Kim/elwha_buffer.shp", overwrite =T)
```

crop and mask tw
```{r}
tw_crop <- crop(tw_crop, elwha_buffer)
tw_mask <- mask(tw_crop, elwha_buffer)

writeVector(tw_mask, "test_rasters_Kim/tw_mask.shp", overwrite =T)

plot(tw_mask)
points(latlong_sites, col = "red")
```


since TerrainWorks has many layers, create list of environmental layers we want to keep
```{r}
tw_mask@ptr[["names"]]
  
#for terrainwork, need list of the columns wanted
tw_list <- list('FlowVel', #Flow velocity (m/s) at bankfull depth
                'StrmPow', #Stream power
                'BFQ', #discharge
                #'ELEV_M', #elevation (m) of downstream end of reach
                'GRADIENT', #Original gradient
                'FROM_DIST', #distance (km) from channel mouth to downstream end of reach 
                #'FISH_RESID', #extent of resident fish habitat which can occur upstream
                'IP_Chinook', #Chinook intrinsic habitat potential
                'IP_Steelhd', #Steelhead intrinsic habitat potential
                #'STRM_ORDER', #Strahler (1952) stream order 
                #'WIDTH_M', #bankfull width (m)
                'DEPTH_M') #bankfull depth (m)
```

#rasterize the shapefiles 
```{r}
FlowVel_raster <- terra::rasterize(tw_mask, myrast, field = 'FlowVel', fun = mean)
plot(FlowVel_raster)
```

```{r}
StrmPow_raster <- terra::rasterize(tw_mask, myrast, field = 'StrmPow', fun = mean)
plot(StrmPow_raster)
```

```{r}
BFQ_raster <- terra::rasterize(tw_mask, myrast, field = 'BFQ', fun = mean)
plot(BFQ_raster)
```

perhaps BFQ is not the best to use... 

```{r}
GRADIENT_raster <- terra::rasterize(tw_mask, myrast, field = 'GRADIENT', fun = mean)
plot(GRADIENT_raster)
```

```{r}
IP_Steelhd_raster <- terra::rasterize(tw_mask, myrast, field = 'IP_Steelhd', fun = mean)
plot(IP_Steelhd_raster)
```

FROM_DIST, IP_Chinook, IP_Steelhead doesn't seem to work...very few pixels with values....  

```{r}
DEPTH_raster <- terra::rasterize(tw_mask, myrast, field = 'DEPTH_M', fun = mean)
plot(DEPTH_raster)
```


### create a raster stack of all individual rasters 

```{r}
mystack <- c(channel_raster, DEPTH_raster, FlowVel_raster, GRADIENT_raster, st_august_raster, StrmPow_raster)

#writeRaster(mystack, "test_rasters_Kim/enviro_stack.tif", overwrite = TRUE)
```

## turning point into buffered sites 
```{r}
sites_buffered <- buffer(latlong_sites, 500)
plot(sites_buffered)

writeVector(sites_buffered, "test_rasters_Kim/sites_buffered.shp", overwrite = TRUE)
```

extract streamtemp from buffered sites
```{r}
dat <- extract(mystack, sites_buffered, method = "simple")
```



remove 0's and NA's from this list 
```{r}
st_august_sites_buffered_filter <- st_august_sites_buffered %>%
  filter(STemp != "NA") %>%
  filter(STemp != 0)
```




tw_rasters <- lapply(tw_list, function(i){
   tmp <- rasterize(tw, myrast, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
 })

, reproject, and then extract
terra::extract(tmp, sites_tw, xy = TRUE, method = 'simple', touches = TRUE, na.rm=TRUE)

## extract August stream temp from sites 

```{r}
st_august_sites <- extract(st_august_raster, latlong_sites, method = "simple")
```





## try to extract data from site locations 

```{r}
test <- extract(mystack, latlong_sites)
```


## need to rename raster layers 



