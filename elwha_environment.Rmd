---
title: "Elwha_EnvironmenalVariables"
author: "Kimberly Ledger"
date: "4/19/2022"
output: github_document
---


#Extract environmental variables 

libraries
```{r, message= FALSE}
library(tidyverse)
library(ggplot2)
library(maps)
library(mapdata)
library(ggrepel)
#library(sf)
#library(rgdal)
library(raster)
library(terra)
```


read in steelhead metadata that has river km and gps locations of sampling sites 

**I changed Time == During individuals to Time == Pre in Elwha_Steelhead_Formatted_kjl.csv** 
```{r}
onmy_metadata <- read.csv("~/Desktop/LG_Proj4/Elwha_datafiles/Elwha_Steelhead_Formatted_kjl.csv")
head(onmy_metadata)
```

create table of sampling sites 
```{r}
sites <- onmy_metadata %>%
  distinct(Lat, Long, rkm, Sampling_Site) %>%
  arrange(rkm)
sites
```

i saved this sites table and combined with the Chinook salmon reaches 

#read in ALL site locations 
```{r}
all_sites <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/elwha_allsites.csv")
```



create NW washington base map
```{r}
state <- map_data("state")

washington <- subset(state, region=="washington")
counties <- map_data("county")
washington_county <- subset(counties, region=="washington")
clallam_co <- subset(washington_county, subregion=="clallam")
jefferson_co <- subset(washington_county, subregion=="jefferson")

map <- ggplot(data=washington, mapping=aes(x=long, y=lat, group=group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color="black", fill=NA) + 
  geom_polygon(data=washington_county, fill=NA, color="gray80") + 
  geom_polygon(color="black", fill=NA) + 
  geom_polygon(data=clallam_co, fill=NA, color="red") + 
  geom_polygon(color="black", fill=NA) + 
  geom_polygon(data=jefferson_co, fill=NA, color="red") + 
  geom_polygon(color="black", fill=NA) + 
  xlim(-125, -122)+
  ylim(47,48.5) + 
  ylab("Latitude") +
  xlab("Longitude") +
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank(),
        axis.title.y=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
  theme_void()

#map
```

plot map with sites
```{r}
site_map <- map + 
  geom_point(data = sites, aes(x = Long, y = Lat, group = Sampling_Site)) +
  geom_text_repel(data = sites, aes(x = Long, y = Lat, group = Sampling_Site, 
                                    label = Sampling_Site), hjust=1, vjust=0.5)

site_map
```


plot just the sampling locations 
```{r}
site_plot <- ggplot(all_sites) + 
  geom_point(data = all_sites, aes(x = Long, y = Lat, col = Species, group = sites_renamed)) +
  geom_text_repel(data = all_sites, aes(x = Long, y = Lat, group = sites_renamed, 
                                    label = sites_renamed), hjust=1, vjust=0.5)
site_plot
```

reproject site locations to match terrainworks data 
```{r}
all_sites2 <- all_sites[-52,]
sites_vect <- vect(all_sites2, geom=c("Long", "Lat"), crs="EPSG: 4326")

Species <- all_sites2$Species
```


read in bioclim layer to use a base raster 
```{r}
#load in the bioclim rasters
bio_layer <- rast("~/Desktop/LG_Proj4/Elwha_environmentaldata/wc2.1_30s_prec/wc2.1_30s_prec_01.tif")

#check projection of raster 
crs(bio_layer)

#going to crop to save space prior to dealing with correlated variables for bioclim
x_min <- xmin(sites_vect)
x_max <- xmax(sites_vect)
y_min <- ymin(sites_vect)
y_max <- ymax(sites_vect)

#create extent object by slightly increasing the min/max values from data
ext <- rast(xmin= (x_min - 0.2), xmax =(x_max + 0.2), 
            ymin= (y_min -0.2), ymax = (y_max + 0.2))

#define crs of this raster
crs(ext) <- crs(bio_layer)

#crop all layers in the stack
bio_crop <- crop(bio_layer, ext)

#plot to double check alignment
plot(bio_crop)
points(sites_vect, col = as.factor(Species))
```


read in TerrainWorks
```{r}
tw <- terra::vect("~/Desktop/LG_Proj4/TerrainWorks_Dung_Elwha_Corrected/Terrainworks_Dung_Elwha.shp")
tw
```


project sites into crs used by TerrainWorks
```{r}
sites_tw <- terra::project(sites_vect, "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs")
```


plot TerrainWorks data with sites 
```{r}
plot(tw)
points(sites_tw, col = "red")
```


reproject cropped bioclim layer to TerrainWorks CRS for cropping and rasterization template
```{r}
bio1 <- terra::project(bio_crop, "+proj=utm +zone=11 +datum=NAD83 +units=m +no_defs")

tw_crop <- crop(tw, bio1)
plot(tw_crop)
points(sites_tw, col = "red")
```

for TerrainWorks, create list of environmental layers we want to keep
```{r}
tw_crop@ptr[["names"]]
  
#for terrainwork, need list of the columns wanted
tw_list <- list('FlowVel', #Flow velocity (m/s) at bankfull depth
                'StrmPow', #Stream power
                'BFQ', #discharge
                'ELEV_M', #elevation (m) of downstream end of reach
                'GRADIENT', #Original gradient
                'FROM_DIST', #distance (km) from channel mouth to downstream end of reach 
                'FISH_RESID', #extent of resident fish habitat which can occur upstream
                'IP_Chinook', #Chinook intrinsic habitat potential
                'IP_Steelhd', #Steelhead intrinsic habitat potential
                'STRM_ORDER', #Strahler (1952) stream order 
                'WIDTH_M', #bankfull width (m)
                'DEPTH_M') #bankfull depth (m)
```

```{r}
plot(tw_crop, 'FROM_DIST')
```




```{r}
tw_lines_buffer <- buffer(tw_crop, 500)

sites_tw_buffer <- buffer(sites_tw, 100)
#plot(sites_tw_buffer)

#rasterize the shapefile, reproject, and then extract
tw_sites <- lapply(tw_list, function(i){
   tmp <- rasterize(tw_lines_buffer, bio1, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
   terra::extract(tmp, sites_tw, xy = TRUE, method = 'simple', touches = TRUE, na.rm=TRUE)
 })

#rasterize the shapefile, reproject, and then extract
tw_sites1 <- lapply(tw_list, function(i){
   tmp <- rasterize(tw_lines_buffer, bio1, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
   terra::extract(tmp, sites_tw_buffer, xy = TRUE, method = 'simple', touches = TRUE, na.rm=TRUE)
 })
 
#rasterize the shapefile, reproject, and then extract
tw_sites2 <- lapply(tw_list, function(i){
   tmp <- rasterize(tw_lines_buffer, bio1, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
   terra::extract(tmp, sites_tw, xy = TRUE, method = 'bilinear', touches = TRUE, na.rm=TRUE)
 })

#rasterize the shapefile, reproject, and then extract
tw_sites3 <- lapply(tw_list, function(i){
   tmp <- rasterize(tw_lines_buffer, bio1, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
   terra::extract(tmp, sites_tw_buffer, xy = TRUE, method = 'bilinear', touches = TRUE, na.rm=TRUE)
 })

#combine all the individual dataframes together
tw_df <- do.call("cbind", tw_sites2)

#remove duplicates (id, x, and y repeat many times from cbind, maybe expore left_join in the future here)
tw_df <- tw_df[!duplicated(as.list(tw_df))]
```

i'm not sure what the best way is to buffer and extract sites... will go with bilinear method for now...

**for terrainworks data, i used the bilinear extraction method for each site**


not all these tw variables seem to useful or calculated in the correct way... 
```{r}
tw_df_trim <- tw_df %>%
  dplyr::select(!FROM_DIST) %>%
  dplyr::select(!FISH_RESID) %>%
  dplyr::select(!IP_Chinook) %>%
  dplyr::select(!IP_Steelhd) %>%
  dplyr::select(!STRM_ORDER) %>%
  dplyr::select(!x) %>%
  dplyr::select(!y) %>%
  dplyr::select(!ID)
```



read in NorWeST data 
```{r}
nw_lines <- vect('~/Desktop/LG_Proj4/Elwha_environmentaldata/NorWeST_PredictedStreamTempLines_WACoast_Aug/NorWeST_PredictedStreamTempLines_WACoast_Aug.shp')

nw_lines
nw_lines@ptr[["names"]]
```

reproject cropped bioclim layer to NorWeST CRS for cropping and rasterization template
```{r}
bio2 <- terra::project(bio_crop, crs(nw_lines))

nw_crop <- crop(nw_lines, bio2)

#convert site crs to match NorWeST
sites_nw <- terra::project(sites_vect, crs(nw_lines)) 

spp_col <- as.factor(Species)

sites_nw_onmy <- sites_nw[spp_col == "Steelhd_Rainbow"]
sites_nw_chin <- sites_nw[spp_col == "Chinook"]

plot(nw_crop)
points(sites_nw_onmy)

plot(nw_crop)
points(sites_nw_chin)
```


temp and flow seem to output odd results using the bilinear extraction methods... will try a simple extraction in a buffer zone around sites and then average the values that makes sense 

```{r}
nw_lines@ptr[["names"]]
  
#for norwest, need list of the columns wanted
nw_list1 <- list('ELEV',
                'CANOPY',
                'SLOPE',
                'PRECIP',
                'CUMDRAINAG')

nw_list2 <- list('Flow_Aug',
                'S1_93_11',
                'S2_02_11')
```



```{r}
nw_lines_buffer <- buffer(nw_lines, 500)

sites_nw_buffer <- buffer(sites_nw, 500)

#rasterize the shapefile, reproject, and then extract
nw_sites1 <- lapply(nw_list1, function(i){
   tmp <- rasterize(nw_lines_buffer, bio2, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
   terra::extract(tmp, sites_nw, xy = TRUE, method = 'bilinear', touches = TRUE, na.rm=TRUE)
 })

#combine all the individual dataframes together
nw_df1 <- do.call("cbind", nw_sites1)
#remove duplicates (id, x, and y repeat many times from cbind, maybe expore left_join in the future here)
nw_df1 <- nw_df1[!duplicated(as.list(nw_df1))]
 
#rasterize the shapefile, reproject, and then extract
nw_sites2 <- lapply(nw_list2, function(i){
   tmp <- rasterize(nw_lines_buffer, bio2, field=paste(i), background = NA)
   tmp[tmp<(-20)] <- NA #remove missing data
   terra::extract(tmp, sites_nw_buffer, xy = TRUE, method = 'simple', touches = TRUE, na.rm=TRUE)
 })
 
#combine all the individual dataframes together
nw_df2 <- do.call("cbind", nw_sites2)

#remove duplicates (id, x, and y repeat many times from cbind, maybe expore left_join in the future here)
nw_df2 <- nw_df2[!duplicated(as.list(nw_df2))]

nw_df2$ID <- as.factor(nw_df2$ID)

nw_df2_ave <- nw_df2 %>%
  group_by(ID) %>% 
  summarise(Flow_Aug = mean(Flow_Aug, na.rm = TRUE), 
            StreamTemp_93_11 = mean(S1_93_11, na.rm = TRUE),
            StreamTemp_02_11 = mean(S2_02_11, na.rm = TRUE))

nw_df <- cbind(nw_df1, nw_df2_ave)

#remove repeatitive ID column
nw_df <- nw_df[,-1] 
```

trim out some varibles from nw_df
```{r}
nw_df_trim <- nw_df %>%
  dplyr::select(!x) %>%
  dplyr::select(!y) %>%
  dplyr::select(!ID) %>%
  dplyr::select(!Flow_Aug)  #no variation among sites
```



combine environmental dataframes 

```{r}
all_enviro <- cbind(all_sites2, nw_df_trim, tw_df_trim)

write.csv(all_enviro, "~/Desktop/LG_Proj4/Elwha_environmentaldata/outputs/environ_extract_22April2022.csv")
```



