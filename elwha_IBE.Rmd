---
title: "elwha_IBE"
author: "Kimberly Ledger"
date: "2022-11-21"
output: github_document
---

## last update: 8 March 2023

## starting by just working with post-dam removal scores

load libraries
```{r, message=FALSE}
library(tidyverse)
library(ggplot2)

## check later what i'm actually using...
#library(nlme)
library(usdm)
#library(corMLPE)
library(lme4)
library(stargazer)
#library(MuMIn)
```


## steelhead 

load data
notes: added back in OUT_DIST manually
```{r}
omy_neutral_scores <- read.csv("~/Desktop/LG_Proj4/Elwha_genetics/outputs/MAR2023/onmy_n_post_dapc.csv") %>%
  rename(Sample_ID = X) %>%
  dplyr::select(Sample_ID, PC1)

omy_adaptive_scores <- readRDS("~/Desktop/LG_Proj4/Elwha_datafiles/2023/IBE_input_Steelhead.rds") %>%
  #rename(Sample_ID = sampleID) %>%
  dplyr::select(Sample_ID, alleleS_count1)

enviro <- read.csv("~/Desktop/LG_Proj4/Elwha_environmentaldata/outputs/final/enviro_summary_reduced_22Feb2023.csv") %>%
  rename(Sampling_Site = X)

omy_metadata <- read.csv("~/Desktop/LG_Proj4/Elwha_datafiles/2023/Elwha_Steelhead_Formatted_Post_022023_sitesfixed_kjl.csv") %>%
  filter(Time == "Post")
```


join the environmental data to the list of omy collection sites
```{r}
omy_sites <- omy_metadata %>%
  distinct(Sampling_Site)
#omy_sites

omy_sites_enviro <- omy_sites %>%
  left_join(enviro, by = "Sampling_Site")
```

create a data frame 
```{r}
omy_df <- omy_metadata %>%
  dplyr::select(Sample_ID, Life_Stage, Life_History_Type, Sampling_Site) %>%
  left_join(omy_sites_enviro, by = "Sampling_Site") %>%
  left_join(omy_neutral_scores, by = "Sample_ID") %>%
  left_join(omy_adaptive_scores, by = "Sample_ID") %>%
  arrange(OUT_DIST) %>%
  drop_na(PC1)
```

## run some mixed effect models

### sort of following worked examples: 
https://bookdown.org/hhwagner1/LandGenCourse_book/WE_6.html#WE_6
https://bookdown.org/hhwagner1/LandGenCourse_book/WE_12.html#WE_12 


### center and scale explainatory variables
```{r}
sample <- omy_df$Sample_ID
PC1 <- omy_df$PC1
PropA <- omy_df$alleleS_count1
site <- omy_df$Sampling_Site
dist <- omy_df$OUT_DIST

for (i in 1:length(colnames(omy_df))){
  if (is.numeric(omy_df[, i])==TRUE)
    omy_df[, i] <- as.numeric(scale(omy_df[, i]))
  else
    omy_df[, i] <- omy_df[, i]
}

## replace values i don't want scaled
omy_df$PC1 <- PC1
omy_df$alleleS_count1 <- PropA
```

check data frame structure
```{r}
omy_df$Sampling_Site <- as.factor(omy_df$Sampling_Site)
str(omy_df)
```

response = PC1 (continuous), the loading score of PC1 from the DAPC analysis using neutral loci OR alleleS_count1 (continuous), the proportion of early run alleles 
explanatory = environmental vars (centered and scaled)
random effect = sampling site

## look at the distribution of the response variable 
```{r}
hist(omy_df$PC1)
hist(omy_df$alleleS_count1)
```

PC1 okay, but will need to use a different distribution for alleleS

## subset dataframe to removed environmental data missing from some sites. 
```{r}
omy_df_reduced <- omy_df %>%
  dplyr::select(!gravels) %>%
  dplyr::select(!fines)
```


## fit candidate models for datasets 

1. Null model: OUT_DIST (aka. Rkm)
2. Climate model: MWMT (max weekly max temp) and PRECIP
3. Flow model: FlowVel, SLOPE 
4. Habitat type: CANOPY, IP_Steelhd, Pool_freq, Logjams, spawnable 
5. Full model: CANOPY, SLOPE, PRECIP, FlowVel, MWMT, IP_Steelhd, Pool_freq, Logjams, Spawnable

## check for multicollinearity - climate model 
```{r}
df <- with(omy_df_reduced, data.frame(MWMT, PRECIP))
usdm::vif(df) 
```

will proceed only with MWMT

## check for multicollinearity - flow model 
```{r}
df <- with(omy_df_reduced, data.frame(FlowVel, SLOPE))
usdm::vif(df) 
```

will keep both 

## check for multicollinearity - habitat model 
```{r}
df <- with(omy_df_reduced, data.frame(CANOPY, IP_Steelhd, Logjams, Pool_freq, Spawnable))
usdm::vif(df) 
```

drop Logjams 

```{r}
df <- with(omy_df_reduced, data.frame(CANOPY, IP_Steelhd, Pool_freq, Spawnable))
usdm::vif(df) 
```

drop Logjams 

## check for multicollinearity - full 
```{r}
df <- with(omy_df_reduced, data.frame(MWMT, FlowVel, CANOPY, IP_Steelhd, Pool_freq, Spawnable))
usdm::vif(df) 
```

drop IP_Steelhd 

```{r}
df <- with(omy_df_reduced, data.frame(MWMT, FlowVel, CANOPY, Pool_freq, Spawnable))
usdm::vif(df) 
```

good to go. 

create subsets for (1) jv all, (2) adult all, (3) adults known steelhead 
```{r}
omy_jv <- omy_df_reduced %>%
  filter(Life_Stage == "Juvenile")

omy_ad <- omy_df_reduced %>%
  filter(Life_Stage == "Adult")
  
omy_ad_stlhd <- omy_ad %>%
  filter(Life_History_Type == "Steelhead")
```

# juveniles 

## set up models - no random effects 
```{r}
mod1 <- lm(PC1 ~ OUT_DIST, data = omy_jv)
mod2 <- lm(PC1 ~ MWMT, data = omy_jv)
mod3 <- lm(PC1 ~ FlowVel + SLOPE, data = omy_jv)
mod4 <- lm(PC1 ~ CANOPY + IP_Steelhd +Pool_freq + Spawnable, data = omy_jv)
mod5 <- lm(PC1 ~ MWMT + FlowVel + CANOPY + Pool_freq + Spawnable, data = omy_jv)
```

## compare models 
```{r}
stargazer(mod1, mod2, mod3, mod4, mod5, 
          type = "text",
          digits = 3, 
          ci = TRUE,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```


week 6 tutorial suggests using the ML fit, as AIC is not valid for REML... 
"The function extractAIC refits the models with ‘REML=FALSE’ to obtain AIC values that are comparable between models with different fixed effects or between models fitted with functions lm and lmer." 

```{r}
aic_vals <- c(extractAIC(mod1)[2], extractAIC(mod2)[2], extractAIC(mod3)[2], 
              extractAIC(mod4)[2], extractAIC(mod5)[2])
names(aic_vals) <- c("mod1","mod2","mod3", "mod4", "mod5")
aic_vals
```

**hmm here mod4 (habitat model) and mod5 (full model) shows lowest AIC**


## check residuals of habitat model 
```{r}
plot(mod4, abline = c(0,0))
#par(mfrow=c(1,2))
#hist(residuals(mod4)) 
#qqnorm(residuals(mod4))
```

looks okay. 

## check residuals of full model 
```{r}
plot(mod5, abline = c(0,0))
#par(mfrow=c(1,2))
#hist(residuals(mod5)) 
#qqnorm(residuals(mod5))
```

# adults 

## set up models - no random effects 
```{r}
mod1 <- lm(PC1 ~ OUT_DIST, data = omy_ad)
mod2 <- lm(PC1 ~ MWMT, data = omy_ad)
mod3 <- lm(PC1 ~ FlowVel + SLOPE, data = omy_ad)
mod4 <- lm(PC1 ~ CANOPY + IP_Steelhd +Pool_freq + Spawnable, data = omy_ad)
mod5 <- lm(PC1 ~ MWMT + FlowVel + CANOPY + Pool_freq + Spawnable, data = omy_ad)
```

## compare models 
```{r}
stargazer(mod1, mod2, mod3, mod4, mod5, 
          type = "text",
          digits = 3, 
          ci = TRUE,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```


```{r}
aic_vals <- c(extractAIC(mod1)[2], extractAIC(mod2)[2], extractAIC(mod3)[2], 
              extractAIC(mod4)[2], extractAIC(mod5)[2])
names(aic_vals) <- c("mod1","mod2","mod3", "mod4", "mod5")
aic_vals
```

** full model (mod5) has lowest AIC ** 

## check residuals of full model 
```{r}
plot(mod5, abline = c(0,0))
#par(mfrow=c(1,2))
#hist(residuals(mod5)) 
#qqnorm(residuals(mod5))
```

# adult steelhead 

## set up models - no random effects 
```{r}
mod1 <- lm(PC1 ~ OUT_DIST, data = omy_ad_stlhd)
mod2 <- lm(PC1 ~ MWMT, data = omy_ad_stlhd)
mod3 <- lm(PC1 ~ FlowVel + SLOPE, data = omy_ad_stlhd)
mod4 <- lm(PC1 ~ CANOPY + IP_Steelhd +Pool_freq + Spawnable, data = omy_ad_stlhd)
mod5 <- lm(PC1 ~ MWMT + FlowVel + CANOPY + Pool_freq + Spawnable, data = omy_ad_stlhd)
```

## compare models 
```{r}
stargazer(mod1, mod2, mod3, mod4, mod5, 
          type = "text",
          digits = 3, 
          ci = TRUE,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```


```{r}
aic_vals <- c(extractAIC(mod1)[2], extractAIC(mod2)[2], extractAIC(mod3)[2], 
              extractAIC(mod4)[2], extractAIC(mod5)[2])
names(aic_vals) <- c("mod1","mod2","mod3", "mod4", "mod5")
aic_vals
```

** full model (mod5) has lowest AIC ** 

## check residuals of full model 
```{r}
plot(mod5, abline = c(0,0))
#par(mfrow=c(1,2))
#hist(residuals(mod5)) 
#qqnorm(residuals(mod5))
```


## now using the adaptive response variable... this is a proportion so go with "family = binomial" in glmer 


```{r}
library(bbmle) # for AICtab
```

# juvenile 

GLMs  
```{r}
mod1_glm <- glm(alleleS_count1  ~ OUT_DIST, family = "binomial", data = omy_jv)
mod2_glm <- glm(alleleS_count1  ~ MWMT, family = "binomial", data = omy_jv)
mod3_glm <- glm(alleleS_count1  ~ FlowVel + SLOPE, family = "binomial", data = omy_jv)
mod4_glm <- glm(alleleS_count1  ~ CANOPY + IP_Steelhd +Pool_freq + Spawnable, family = "binomial", data = omy_jv)
mod5_glm <- glm(alleleS_count1  ~ MWMT + FlowVel + CANOPY + Pool_freq + Spawnable, family = "binomial", data = omy_jv)
```


```{r}
AICtab(mod1_glm, mod2_glm, mod3_glm, mod4_glm, mod5_glm)
```

mod4 (habitat) and mod5 (full) have lowest AIC

```{r}
stargazer(mod1_glm, mod2_glm, mod3_glm, mod4_glm, mod5_glm, 
          type = "text",
          digits = 3, 
          ci = TRUE,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```


model checking and diagnostics 

## check residuals of model 
```{r}
plot(mod4_glm, abline = c(0,0))
plot(mod5_glm, abline = c(0,0))
```


# adults

GLMs  
```{r}
mod1_glm <- glm(alleleS_count1  ~ OUT_DIST, family = "binomial", data = omy_ad)
mod2_glm <- glm(alleleS_count1  ~ MWMT, family = "binomial", data = omy_ad)
mod3_glm <- glm(alleleS_count1  ~ FlowVel + SLOPE, family = "binomial", data = omy_ad)
mod4_glm <- glm(alleleS_count1  ~ CANOPY + IP_Steelhd +Pool_freq + Spawnable, family = "binomial", data = omy_ad)
mod5_glm <- glm(alleleS_count1  ~ MWMT + FlowVel + CANOPY + Pool_freq + Spawnable, family = "binomial", data = omy_ad)
```


```{r}
AICtab(mod1_glm, mod2_glm, mod3_glm, mod4_glm, mod5_glm)
```

mod1 (rKM), mod4 (habitat) and mod5 (full) have lowest AIC

```{r}
stargazer(mod1_glm, mod2_glm, mod3_glm, mod4_glm, mod5_glm, 
          type = "text",
          digits = 3, 
          ci = TRUE,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```


model checking and diagnostics 

## check residuals of model 
```{r}
plot(mod1_glm, abline = c(0,0))
plot(mod4_glm, abline = c(0,0))
plot(mod5_glm, abline = c(0,0))
```


# steelhead

GLMs  
```{r}
mod1_glm <- glm(alleleS_count1  ~ OUT_DIST, family = "binomial", data = omy_ad_stlhd)
mod2_glm <- glm(alleleS_count1  ~ MWMT, family = "binomial", data = omy_ad_stlhd)
mod3_glm <- glm(alleleS_count1  ~ FlowVel + SLOPE, family = "binomial", data = omy_ad_stlhd)
mod4_glm <- glm(alleleS_count1  ~ CANOPY + IP_Steelhd +Pool_freq + Spawnable, family = "binomial", data = omy_ad_stlhd)
mod5_glm <- glm(alleleS_count1  ~ MWMT + FlowVel + CANOPY + Pool_freq + Spawnable, family = "binomial", data = omy_ad_stlhd)
```


```{r}
AICtab(mod1_glm, mod2_glm, mod3_glm, mod4_glm, mod5_glm)
```

mod1 (rKM) has lowest AIC

```{r}
stargazer(mod1_glm, mod2_glm, mod3_glm, mod4_glm, mod5_glm, 
          type = "text",
          digits = 3, 
          ci = TRUE,
          star.cutoffs = c(0.05, 0.01, 0.001),
          digit.separator = "")
```


model checking and diagnostics 

## check residuals of model 
```{r}
plot(mod1_glm, abline = c(0,0))
```


